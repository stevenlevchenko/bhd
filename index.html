<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Blackhawk Data – Dashboard (NYC first, Virag last, 11 tiles)</title>
<link rel="preconnect" href="https://www.youtube.com" />
<link rel="preconnect" href="https://www.youtube-nocookie.com" />
<link rel="preconnect" href="https://i.ytimg.com" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0a0f1a;--card:#0f1726;--muted:#7d8aa5;--accent:#1e90ff;--border:#1b2440;--text:#e6eefc;--radius:16px}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:var(--bg)}
  header{position:sticky;top:0;z-index:10;background:#0b1220;border-bottom:1px solid var(--border);backdrop-filter:blur(8px)}
  .bar{max-width:1600px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:10px}
  .grow{flex:1} .badge{font-variant-numeric:tabular-nums;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0b1624}
  main{max-width:1600px;margin:16px auto;padding:0 16px 24px}
  .grid{display:grid;gap:16px;grid-template-columns:repeat(12,1fr);grid-auto-rows:minmax(160px,auto)}
  .tile{grid-column:span 12;background:#0e1729;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column}
  .tile h2{margin:0;padding:10px 12px;font-size:16px;border-bottom:1px solid var(--border);background:#0b1424}
  .tile .content{padding:12px}
  .cams-grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
  .cam{grid-column:span 12;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#000;display:flex;flex-direction:column}
  @media(min-width:700px){.cam{grid-column:span 6}} @media(min-width:1200px){.cam{grid-column:span 4}}
  .media{position:relative;width:100%;padding-top:56.25%;background:#000}
  .media iframe,.media img{position:absolute;inset:0;width:100%;height:100%;border:0;display:block;object-fit:cover}
  .meta{display:flex;justify-content:space-between;gap:10px;padding:8px 10px;background:#0b1624;border-top:1px solid var(--border)}
  .name{font-weight:700;font-size:14px} .city{font-size:12px;color:#9bb2d6}
  .tiny{font-size:11px;padding:4px 8px;border-radius:8px;border:1px solid var(--border);background:#0c1428;color:#9fdcff;cursor:pointer}
  /* Snapshot stamp */
  .snapwrap{position:relative;width:100%;padding-top:56.25%;background:#000}
  .snapwrap img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;display:block;background:#000}
  .snapwrap .stamp{position:absolute;left:8px;bottom:8px;font-size:12px;padding:6px 8px;border-radius:10px;border:1px solid var(--border);
                   background:rgba(10,15,26,.6);backdrop-filter:blur(6px);color:var(--text)}
</style>
</head>
<body>
  <header>
    <div class="bar">
      <strong>Blackhawk Data — Engineer Weather Cams</strong>
      <div class="grow"></div>
      <span id="tileCounter" class="badge">Tiles: --</span>
      <span id="clock" class="badge">--:--:-- ET</span>
    </div>
  </header>

  <main>
    <div class="grid">
      <section class="tile">
        <h2>Engineer Weather Cams – Autoplay/Snapshots</h2>
        <div class="content">
          <div class="cams-grid" id="camsGrid"></div>
          <p class="muted" style="margin-top:8px">YouTube tiles autoplay muted. Snapshot tiles show a timestamp and refresh automatically.</p>
        </div>
      </section>
    </div>
  </main>

<script>
  // Clock
  const clockEl=document.getElementById('clock');
  function tick(){ try{ const s=new Intl.DateTimeFormat('en-US',{timeZone:'America/New_York',hour12:false,timeStyle:'medium'}).format(new Date()); clockEl.textContent=s+' ET'; }catch{ clockEl.textContent=new Date().toLocaleTimeString()+' ET'; } requestAnimationFrame(()=>setTimeout(tick,500)); } tick();

  // Name formatter (Firstname L. when a space exists)
  function formatName(n){
    const s=String(n||'').trim();
    if(!s) return s;
    const parts=s.split(/\s+/);
    if(parts.length<2) return s;
    return parts[0] + ' ' + parts[1][0].toUpperCase() + '.';
  }

  // YouTube API + keep-live
  (function(){ const s=document.createElement('script'); s.src='https://www.youtube.com/iframe_api'; s.async=true; document.head.appendChild(s); })();
  function ytIdFromUrl(u){ try{ const url=new URL(u); if(url.hostname.includes('youtu')){ if(url.pathname.startsWith('/watch')) return url.searchParams.get('v'); if(url.hostname==='youtu.be') return url.pathname.slice(1); const m=url.pathname.match(/\/embed\/([A-Za-z0-9_\-]+)/); if(m) return m[1]; return url.searchParams.get('v'); } }catch{} return null; }
  function buildVideoPlayer(el, videoId){
    if(!window.YT || !window.YT.Player){ setTimeout(()=>buildVideoPlayer(el, videoId), 150); return; }
    const p=new YT.Player(el,{ videoId, playerVars:{autoplay:1,mute:1,playsinline:1,rel:0,controls:1,modestbranding:1},
      events:{ onReady:(e)=>{ try{e.target.mute(); e.target.playVideo();}catch{} },
        onStateChange:(e)=>{ if([YT.PlayerState.PAUSED,YT.PlayerState.UNSTARTED,YT.PlayerState.ENDED].includes(e.data)){ try{e.target.playVideo();}catch{} } } } });
    setInterval(()=>{ try{ if(p.getPlayerState&&p.getPlayerState()!==YT.PlayerState.PLAYING){ p.playVideo(); } p.mute(); }catch{} },15000);
  }

  // Snapshot helpers
  function toETString(d){ try{ return new Intl.DateTimeFormat('en-US',{timeZone:'America/New_York',hour12:false,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(d)+' ET'; }catch{ return d.toISOString(); } }
  async function tryLastModified(url){ try{ const r=await fetch(url,{method:'HEAD',cache:'no-store'}); const lm=r.headers.get('Last-Modified'); if(lm){ const dt=new Date(lm); if(!isNaN(dt)) return dt; } }catch{} return null; }
  function scheduleRefresh(imgEl, baseUrl, minSec, maxSec, stampEl){
    async function doRefresh(){
      const bust=Date.now(); const full=baseUrl+(baseUrl.includes('?')?'&':'?')+'t='+bust;
      let when=null; try{ const dt=await tryLastModified(baseUrl); if(dt) when=toETString(dt)+' (server)'; }catch{}
      imgEl.onload=()=>{ if(!when) when=toETString(new Date())+' (local)'; if(stampEl) stampEl.textContent='Updated: '+when; };
      imgEl.src=full;
      const delay=minSec*1000+Math.random()*((maxSec-minSec)*1000); setTimeout(doRefresh, Math.round(delay));
    }
    doRefresh();
  }

  // Card builders
  function addYouTubeCard(cfg){
    const card=document.createElement('article'); card.className='cam';
    const wrap=document.createElement('div'); wrap.className='media'; card.appendChild(wrap);
    const mount=document.createElement('div'); mount.style.cssText='position:absolute;inset:0'; wrap.appendChild(mount);
    const id=ytIdFromUrl(cfg.url);
    if(id) buildVideoPlayer(mount,id); else mount.innerHTML='<div style="color:#9bb2d6;display:flex;align-items:center;justify-content:center">Invalid YouTube URL</div>';
    const meta=document.createElement('div'); meta.className='meta';
    meta.innerHTML='<div><div class="name">'+formatName(cfg.who)+'</div><div class="city">'+cfg.city+', '+cfg.state+'</div></div>';
    const actions=document.createElement('div');
    const open=document.createElement('a'); open.className='tiny'; open.href=cfg.url; open.target='_blank'; open.rel='noopener'; open.textContent='Open source';
    actions.appendChild(open); meta.appendChild(actions); card.appendChild(meta); grid.appendChild(card);
  }
  function addSnapshotCard(cfg){
    const card=document.createElement('article'); card.className='cam';
    const wrap=document.createElement('div'); wrap.className='snapwrap';
    const img=document.createElement('img'); img.alt=(cfg.city||'')+', '+(cfg.state||'')+' – refreshing image'; img.referrerPolicy='no-referrer';
    wrap.appendChild(img);
    const stamp=document.createElement('div'); stamp.className='stamp'; stamp.textContent='Updated: …'; wrap.appendChild(stamp);
    scheduleRefresh(img, cfg.url, cfg.minSec||15, cfg.maxSec||30, stamp);
    card.appendChild(wrap);
    const meta=document.createElement('div'); meta.className='meta';
    meta.innerHTML='<div><div class="name">'+formatName(cfg.who)+'</div><div class="city">'+cfg.city+', '+cfg.state+'</div></div>';
    const actions=document.createElement('div');
    const open=document.createElement('a'); open.className='tiny'; open.href=cfg.url; open.target='_blank'; open.rel='noopener'; open.textContent='Open source';
    actions.appendChild(open); meta.appendChild(actions); card.appendChild(meta); grid.appendChild(card);
  }
  
function addUrlCard(cfg){
  const card=document.createElement('article'); card.className='cam';
  const wrap=document.createElement('div'); wrap.className='media'; card.appendChild(wrap);

  const ifr=document.createElement('iframe');
  ifr.src = cfg.url;
  ifr.loading = 'eager';                    // prefer immediate load to test embed
  ifr.referrerPolicy = 'no-referrer-when-downgrade';
  ifr.allow = 'autoplay; fullscreen; picture-in-picture; encrypted-media';
  ifr.setAttribute('allowfullscreen','');
  wrap.appendChild(ifr);

  // Fallback overlay if the frame appears blocked/blank
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:absolute;inset:0;display:flex;align-items:center;justify-content:center;gap:8px;background:transparent;pointer-events:none';
  const openBtn = document.createElement('a');
  openBtn.className='tiny'; openBtn.textContent='Open source';
  openBtn.href = cfg.url; openBtn.target='_blank'; openBtn.rel='noopener';
  openBtn.style.pointerEvents='auto';
  const note = document.createElement('span');
  note.className='tiny'; note.textContent='(embed may be blocked)';
  overlay.appendChild(openBtn); overlay.appendChild(note);
  wrap.appendChild(overlay);

  // Heuristic: if no onload within 4s, keep overlay visible; otherwise hide it
  let loaded=false;
  ifr.addEventListener('load', ()=>{ loaded=true; overlay.style.display='none'; });
  setTimeout(()=>{ if(!loaded){ overlay.style.display='flex'; } }, 4000);

  // Periodic refresh to recover from stalls (every 120s)
  setInterval(()=>{
    try{
      const base = cfg.url.split('#')[0];
      const sep = base.includes('?') ? '&' : '?';
      ifr.src = base + sep + 't=' + Date.now();
    }catch{}
  }, 120000);

  const meta=document.createElement('div'); meta.className='meta';
  meta.innerHTML='<div><div class="name">'+formatName(cfg.who)+'</div><div class="city">'+(cfg.city||'')+', '+(cfg.state||'')+'</div></div>';
  const actions=document.createElement('div');
  const open=document.createElement('a'); open.className='tiny'; open.href=cfg.url; open.target='_blank'; open.rel='noopener'; open.textContent='Open source';
  actions.appendChild(open);
  meta.appendChild(actions); card.appendChild(meta); grid.appendChild(card);
}
// Cams — 11 entries, NYC first, Virag last. Nathan omitted.
  const cams=[
    { who:'NYC',              kind:'youtube', url:'https://www.youtube.com/watch?v=TsgoxkRFit0', city:'New York City', state:'NY' },
    { who:'Rafael Caballero', kind:'snapshot+stamp', url:'https://wjla.com/resources/ftptransfer/wjla/maps/WEB_WINCHESTER.jpg', city:'Roanoke', state:'VA', minSec:30, maxSec:30 },
    { who:'Lauren Gonzalez',  kind:'youtube', url:'https://www.youtube.com/watch?v=wUQc3RoLAPs', city:'Houston', state:'TX' },
    { who:'Joe Golemb',       kind:'youtube', url:'https://www.youtube.com/watch?v=ATbtGvbExP4', city:'Nashville', state:'TN' },
    { who:'Jacob T',          kind:'youtube', url:'https://www.youtube.com/watch?v=V0ViqZ-QAD0', city:'Jonesborough', state:'TN' },
    { who:'Jake Fitzgerald',  kind:'youtube', url:'https://www.youtube.com/watch?v=i07IVN7ZKek', city:'Manchester / NH region', state:'NH' },
    { who:'Steve Luton',      kind:'youtube', url:'https://www.youtube.com/watch?v=E_VpviMTH9k', city:'Denver', state:'CO' },
    { who:'Noah Herald',      kind:'youtube', url:'https://www.youtube.com/watch?v=a89gExUKAu4', city:'Greensboro (Triad)', state:'NC' },
    { who:'Dallas Munday',    kind:'snapshot+stamp', url:'https://usgs-nims-images.s3.amazonaws.com/overlay/NJ_Stony_Brook_at_Princeton/NJ_Stony_Brook_at_Princeton_newest.jpg', city:'Princeton (Stony Brook)', state:'NJ', minSec:15, maxSec:30 },
    { who:'Steven Levchenko', kind:'snapshot+stamp', url:'https://map.eye-n-sky.net/webcam/Caldwell/Caldwell-East.jpg', city:'Caldwell (near Star/Boise area)', state:'ID', minSec:15, maxSec:30 },
    { who:'Virag Doshi',      kind:'url',     url:'https://myearthcam.com/kaliking', city:'', state:'' }
  ];

  // Build grid (snapshot first ensures Rafael/Dallas/Steven render correctly)
  const grid=document.getElementById('camsGrid');
  cams.forEach(c=>{
    try{
      if(c.kind && c.kind.startsWith('snapshot')) addSnapshotCard(c);
      else if(c.kind==='youtube') addYouTubeCard(c);
      else if(c.kind==='url') addUrlCard(c);
      else { throw new Error('Unknown kind: '+c.kind); }
    }catch(err){
      const card=document.createElement('article'); card.className='cam';
      const wrap=document.createElement('div'); wrap.className='media'; wrap.innerHTML='<div style="color:#9bb2d6;padding:10px">Failed to render tile</div>';
      card.appendChild(wrap);
      const meta=document.createElement('div'); meta.className='meta';
      meta.innerHTML='<div><div class="name">'+formatName(c.who||'Unknown')+'</div><div class="city">'+(c.city||'')+', '+(c.state||'')+'</div></div>';
      const actions=document.createElement('div'); const open=document.createElement('a'); open.className='tiny'; open.href=c.url||'#'; open.target='_blank'; open.rel='noopener'; open.textContent='Open source';
      actions.appendChild(open); meta.appendChild(actions); card.appendChild(meta); grid.appendChild(card);
      console.error('Tile error for', c, err);
    }
  });

  // Counter
  const counterEl=document.getElementById('tileCounter');
  function updateCounter(){ counterEl.textContent='Tiles: '+grid.childElementCount; }
  updateCounter(); new MutationObserver(updateCounter).observe(grid,{childList:true});
</script>
</body>
</html>
